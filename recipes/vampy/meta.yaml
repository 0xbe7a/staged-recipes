{% set name = "VaMPy" %}
{% set version = "1.0.5" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://github.com/KVSlab/VaMPy/archive/v{{ version }}.tar.gz
  sha256: cf1e6cb737a8bc0c49527e412e154e7fc28ef7f7a2ceff9a3e9b91c6a9c8a7fa

build:
  entry_points:
    - vampy-mesh = vampy.automatedPreprocessing.automated_preprocessing:main_meshing
    - vampy-hemo = vampy.automatedPostprocessing.compute_hemodynamic_indices:main_hemo
    - vampy-metrics = vampy.automatedPostprocessing.compute_flow_and_simulation_metrics:main_metrics
    - vampy-convert = vampy.automatedPostprocessing.compute_velocity_and_pressure:main_convert
    - vampy-probe = vampy.automatedPostprocessing.visualize_probes:main_probe
  noarch: python
  script: {{ PYTHON }} -m pip install . -vv --no-deps --no-build-isolation
  number: 0

requirements:
  host:
    - python {{ python_min }}
    - setuptools >=61.0.0
    - wheel
    - pip
  run:
    - python >={{ python_min }}
    - fenics >=2019.1.0
    - fenics-oasis
    - vtk
    - vmtk
    - morphman
    - numpy
    - matplotlib-base
    - scipy
    - paramiko
    - expat ==2.5.0  # Fixes VTK XML parsing issue

test:
  source_files:
    - tests/*
    - src/*
  commands:
    # Temporarily disabled due to upstream pybind11 issue in fenics
    # See: https://github.com/conda-forge/fenics-feedstock/pull/256
    # - pip check
    - bash -c 'command -v xvfb-run >/dev/null && xvfb-run -a vampy-mesh --help || vampy-mesh --help'
    - bash -c 'command -v xvfb-run >/dev/null && xvfb-run -a vampy-hemo --help || vampy-hemo --help'
    - bash -c 'command -v xvfb-run >/dev/null && xvfb-run -a vampy-metrics --help || vampy-metrics --help'
    - bash -c 'command -v xvfb-run >/dev/null && xvfb-run -a vampy-convert --help || vampy-convert --help'
    - bash -c 'command -v xvfb-run >/dev/null && xvfb-run -a vampy-probe --help || vampy-probe --help'
    # `test_simulation.py` requires OasisMove, which is not available as a conda package.
    - bash -c 'command -v xvfb-run >/dev/null && xvfb-run -a pytest --ignore=tests/test_simulation.py || pytest --ignore=tests/test_simulation.py'
  requires:
    - python {{ python_min }}
    - pip
    - pytest

about:
  home: https://github.com/KVSlab/VaMPy
  summary: Automated and objective tools used to prepare, run, and analyze vascular morphologies.
  description: |
    The Vascular Modeling Pypeline (VaMPy) is a collection of fully automated scripts used to prepare, run, and analyze cardiac and atrial morphologies. This includes pre-processing scripts for meshing and probe sampling, two Oasis problem files for simulating flow in the internal carotid artery and the left atrium, and a variety of post-processing scripts for computing WSS-based metrics, more advanced turbulence metrics, and a variety of morphological parameters in patient-specific geometries.
  license: GPL-3.0-or-later
  license_family: GPL3
  license_file: LICENSE
  doc_url: https://kvslab.github.io/VaMPy
  dev_url: https://github.com/KVSlab/VaMPy

extra:
  recipe-maintainers:
    - johannesring
    - keiyamamo
