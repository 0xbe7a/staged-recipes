# yaml-language-server: $schema=https://raw.githubusercontent.com/prefix-dev/recipe-format/main/schema.json
schema_version: 1

context:
  version: "1.9.3"
  python_check_max: "3.13"
  linkml_runtime_min: "1.9.4"
  numpydantic_min: "1.6.1"
  pandera_min: "0.19.0"
  polars_lts_cpu_min: "1.0.0"
  pyshacl_min: "0.25.0"

recipe:
  name: linkml
  version: ${{ version }}

source:
  - url: https://pypi.org/packages/source/l/linkml/linkml-${{ version }}.tar.gz
    sha256: 96de208001dae5bde43092ce0f3fab61df4c85231939476dc3f93d0b5b0d4590
    target_directory: dist
  - url: https://github.com/linkml/linkml/archive/refs/tags/v${{ version }}.tar.gz
    sha256: c839a294281de95f1538a3dde356e93bc422c674dc0eae6758c03e98d04dc677
    target_directory: src

build:
  number: 0
  noarch: python

outputs:
  - package:
      name: linkml
    build:
      noarch: python
      script:
        - cd dist
        - ${{ PYTHON }} -m pip install . -vv --no-deps --no-build-isolation --disable-pip-version-check
      python:
        entry_points:
          - gen-csv = linkml.generators.csvgen:cli
          - gen-dbml = linkml.generators.dbmlgen:cli
          - gen-doc = linkml.generators.docgen:cli
          - gen-erdiagram = linkml.generators.erdiagramgen:cli
          - gen-excel = linkml.generators.excelgen:cli
          - gen-golang = linkml.generators.golanggen:cli
          - gen-golr-views = linkml.generators.golrgen:cli
          - gen-graphql = linkml.generators.graphqlgen:cli
          - gen-graphviz = linkml.generators.dotgen:cli
          - gen-java = linkml.generators.javagen:cli
          - gen-json-schema = linkml.generators.jsonschemagen:cli
          - gen-jsonld = linkml.generators.jsonldgen:cli
          - gen-jsonld-context = linkml.generators.jsonldcontextgen:cli
          - gen-linkml = linkml.generators.linkmlgen:cli
          - gen-markdown = linkml.generators.markdowngen:cli
          - gen-mermaid-class-diagram = linkml.generators.mermaidclassdiagramgen:cli
          - gen-namespaces = linkml.generators.namespacegen:cli
          - gen-owl = linkml.generators.owlgen:cli
          - gen-pandera = linkml.generators.panderagen:cli
          - gen-plantuml = linkml.generators.plantumlgen:cli
          - gen-prefix-map = linkml.generators.prefixmapgen:cli
          - gen-project = linkml.generators.projectgen:cli
          - gen-proto = linkml.generators.protogen:cli
          - gen-py-classes = linkml.generators.pythongen:cli
          - gen-pydantic = linkml.generators.pydanticgen:cli
          - gen-python = linkml.generators.pythongen:cli
          - gen-rdf = linkml.generators.rdfgen:cli
          - gen-shacl = linkml.generators.shaclgen:cli
          - gen-shex = linkml.generators.shexgen:cli
          - gen-sparql = linkml.generators.sparqlgen:cli
          - gen-sqla = linkml.generators.sqlalchemygen:cli
          - gen-sqlddl = linkml.generators.sqltablegen:cli
          - gen-sqltables = linkml.generators.sqltablegen:cli
          - gen-sssom = linkml.generators.sssomgen:cli
          - gen-summary = linkml.generators.summarygen:cli
          - gen-terminusdb = linkml.generators.terminusdbgen:cli
          - gen-typescript = linkml.generators.typescriptgen:cli
          - gen-yaml = linkml.generators.yamlgen:cli
          - gen-yuml = linkml.generators.yumlgen:cli
          - linkml = linkml.cli.main:linkml
          - linkml-convert = linkml.utils.converter:cli
          - linkml-jsonschema-validate = linkml.validators.jsonschemavalidator:cli
          - linkml-lint = linkml.linter.cli:main
          - linkml-run-examples = linkml.workspaces.example_runner:cli
          - linkml-schema-fixer = linkml.utils.schema_fixer:main
          - linkml-sparql-validate = linkml.validators.sparqlvalidator:cli
          - linkml-sqldb = linkml.utils.sqlutils:main
          - linkml-validate = linkml.validator.cli:cli
          - run-tutorial = linkml.utils.execute_tutorial:cli
    requirements:
      host:
        - python ${{ python_min }}.*
        - poetry-core
        - poetry-dynamic-versioning
        - pip
      run:
        - antlr4-python3-runtime >=4.9.0,<4.10
        - click >=7.0
        - hbreader
        - isodate >=0.6.0
        - jinja2 >=3.1.0
        - jsonasobj2 >=1.0.3,<2.0.0
        - jsonschema >=4.0.0
        - linkml-runtime >=${{ linkml_runtime_min }},<2.0.0
        - openpyxl
        - parse
        - prefixcommons >=0.1.7
        - prefixmaps >=0.2.2
        - pydantic >=1.0.0,<3.0.0
        - pyjsg >=0.11.6
        - pyshex >=0.7.20
        - pyshexc >=0.8.3
        - python >=${{ python_min }}
        - python-dateutil
        - python-graphviz >=0.10.1
        - pyyaml
        - rdflib >=6.0.0
        - requests >=2.22
        - sphinx-click >=6.0.0
        - sqlalchemy >=1.4.31
        - typing_extensions >=4.6.0
        - watchdog >=0.9.0
      run_constraints:
        # hard constraints in subpackages below
        - numpydantic >=${{ numpydantic_min }}
        - pandera >=${{ pandera_min }}
        - polars-lts-cpu >=${{ polars_lts_cpu_min }}
        - pyshacl >=${{ pyshacl_min }}
    tests:
      - python:
          imports: linkml
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*

  # pypi extras ################################################################
  - package:
      name: linkml-with-numpydantic
    build:
      noarch: generic
    requirements:
      run:
        - ${{ pin_subpackage("linkml", exact=True) }}
        - numpydantic
    tests:
      - python:
          imports: linkml
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
    about:
      summary: Linked Open Data Modeling Language (with numpydantic)

  - package:
      name: linkml-with-pandera
    build:
      noarch: generic
    requirements:
      run:
        - ${{ pin_subpackage("linkml", exact=True) }}
        - pandera
    tests:
      - python:
          imports: linkml
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
    about:
      summary: Linked Open Data Modeling Language (with pandera)

  - package:
      name: linkml-with-polars-lts-cpu
    build:
      noarch: generic
    requirements:
      run:
        - ${{ pin_subpackage("linkml", exact=True) }}
        - polars-lts-cpu
    tests:
      - python:
          imports: linkml
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
    about:
      summary: Linked Open Data Modeling Language (with polars)

  - package:
      name: linkml-with-pyshacl
    build:
      noarch: generic
    requirements:
      run:
        - ${{ pin_subpackage("linkml", exact=True) }}
        - pyshacl
    tests:
      - python:
          imports: linkml
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
    about:
      summary: Linked Open Data Modeling Language (with pyshacl)

  # fan-in package of runtime ##################################################
  - package:
      name: linkml-with-all
    build:
      noarch: generic
    requirements:
      run:
        - ${{ pin_subpackage("linkml-with-numpydantic",    exact=True) }}
        - ${{ pin_subpackage("linkml-with-pandera",        exact=True) }}
        - ${{ pin_subpackage("linkml-with-polars-lts-cpu", exact=True) }}
        - ${{ pin_subpackage("linkml-with-pyshacl",        exact=True) }}
    tests:
      - python:
          imports: linkml
          pip_check: true
          python_version:
            - ${{ python_min }}.*
            - ${{ python_check_max }}.*
      - requirements:
          run:
            - linkml-runtime ${{ linkml_runtime_min }}.*
            - numpydantic ${{ numpydantic_min }}.*
            - pandera ${{ pandera_min }}.*
            - pip
            - polars-lts-cpu ${{ polars_lts_cpu_min }}.*
            - pyshacl ${{ pyshacl_min }}.*
            - python ${{ python_min }}.*
        script:
          - pip check
    about:
      summary: Linked Open Data Modeling Language (with all)

  # test-only package ##########################################################
  - package:
      name: _linkml_with_all_tests
    build:
      noarch: generic
    requirements:
      run:
        - ${{ pin_subpackage("linkml-with-all", exact=True) }}
    tests:
      - files:
          source:
            - src/notebooks/
            - src/pyproject.toml
            - src/tests/
          recipe:
            - run_test.py
        requirements:
          run:
            - coverage >=6.4.1,<7.0.0
            - jsonpatch >=1.33.0,<2.0.0
            - mock >=5.1.0,<6
            - nbconvert
            - pytest >=7.4.0,<8.0.0
            - pytest-subtests >=0.11.0,<0.12.0
            - python ${{ python_min }}.*
            - requests-cache >=1.2.0,<2.0.0
            - testcontainers
            - tomli
        script:
          file: run_test.py
          interpreter: python
    about:
      summary: Linked Open Data Modeling Language (with test suite)

about:
  summary: Linked Open Data Modeling Language
  license: Apache-2.0
  license_file: dist/LICENSE
  homepage: https://linkml.io
  documentation: https://linkml.io/linkml
  repository: https://github.com/linkml/linkml
  description: |
    LinkML is a flexible modeling language that allows you to author schemas in 
    YAML that describe the structure of your data. Additionally, it is a 
    framework for working with and validating data in a variety of formats 
    (JSON, RDF, TSV), with generators for compiling LinkML schemas to other 
    frameworks.

extra:
  feedstock-name: linkml
  recipe-maintainers:
    - bollwyvl
