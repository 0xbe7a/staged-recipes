schema_version: 1

context:
  version: 1.0.0

package:
  name: libplanc
  version: ${{ version|replace("-", "_") }}

source:
  url: https://github.com/welch-lab/libplanc/archive/refs/tags/${{ version }}.tar.gz
  sha256: 6de3cc449c03d4ec2d9ebc22dfaa8a66bef62aa798b48a7e9fefaf2056db607d

build:
  number: 0
  script:
    if: unix
    then:
    - mkdir -p $RECIPE_DIR/build
    - cd $RECIPE_DIR/build
    - cmake -S ..
    - cmake --build .
    - cmake --install .
    else:
      - mkdir -p %RECIPE_DIR%\\build
      - cd %RECIPE_DIR%\\build
      - cmake -S ..
      - cmake --build .
      - cmake --install .

requirements:
  build:
    - if: unix
      then:
        - gnuconfig
        - git
        - diffutils
        - patch
    - if: not win
      then:
        - ${{ compiler('c') }}
        - ${{ stdlib("c") }}
        - ${{ compiler('cxx') }}
    - if: win
      then:
        - ${{ compiler('m2w64_c') }}
        - ${{ stdlib("m2w64_c") }}
        - ${{ compiler('m2w64_cxx') }}
        - m2-filesystem
        - m2-zip
        - m2-diffutils
        - m2-patch
    - if: osx
      then: llvm-openmp
      else: libgomp
    - cmake >=3.22
    - make
    - pkg-config
  host:
    - libhwloc >=2.0.0,<3.0.0
    - zlib
    - hdf5 >=1.10
    - if: osx
      then: llvm-openmp
      else: libgomp
    - libblas
    - libcblas
    - liblapack
    - indicators
    - armadillo
    - if: win
      then: dlfcn-win32
  run:
    - if: osx and arm64
      then: libblas * *accelerate
      else: libblas
    - if: win
      then: libgomp

tests:
  script:
    if: win
    then: if not exist %LIBRARY_LIB%\\libnmflib.dll exit 1
    else: test -f $PREFIX/lib/libnmflib$SHLIB_EXT

about:
  license: GPL-2.0-or-later
  summary: '''PLANC'', a highly parallel and extensible NMF/NTF  (Non-negative Matrix/Tensor Factorization) library. Wraps algorithms described in Kannan et. al (2018) <doi:10.1109/TKDE.2017.2767592> and Eswar et. al (2021) <doi:10.1145/3432185>. Implements algorithms described in Welch et al. (2019) <doi:10.1016/j.cell.2019.05.006>, Gao et al. (2021) <doi:10.1038/s41587-021-00867-x>, and Kriebel & Welch (2022) <doi:10.1038/s41467-022-28431-4>.'
  license_file:
    - README.md
  homepage: https://github.com/welch-lab/libplanc

extra:
  recipe-maintainers:
    - theAeon
